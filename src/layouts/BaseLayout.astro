---
// src/layouts/BaseLayout.astro

interface Props {
  pageTitle?: string;
  subtitle?: string;
  showCanvas?: boolean;
  enableLinks?: boolean;
}

const {
  pageTitle = "KoLLOID",
  subtitle = "とけない個のための表現空間",
  showCanvas = true,
  enableLinks = false,
} = Astro.props;
---

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>{pageTitle}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- favicon（タブ・ブックマーク用） -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-v2.png" />

    {/* 粒子背景用の p5.js */}
    {showCanvas && (
      <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
    )}

    <style>
      /* （CSSはそのまま） */
      body {
        margin: 0;
        min-height: 100vh;
        background: #f7f5f2;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: #333;
      }

      header.site-header {
        padding: 1.2rem 1.5rem;
        max-width: 960px;
        margin: 0 auto;
        margin-top: 2rem;
        position: relative;
        height: 64px;
        display: flex;
        align-items: center;
      }

      .site-title-link {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: inline-flex;
        align-items: center;
        text-decoration: none;
      }

      .site-logo {
        height: 168px;
        width: auto;
        display: block;
        opacity: 0.92;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .site-title-link:hover .site-logo {
        opacity: 0.8;
        transform: translateY(-1px);
      }

      nav.site-nav {
        position: absolute;
        right: 1.5rem;
        top: 1.2rem;
      }

      nav.site-nav a {
        text-decoration: none;
        color: #666;
        font-size: 1.3rem;
        margin-left: 1rem;
        position: relative;
        transition: color 0.2s ease;
      }

      nav.site-nav a:hover {
        color: #333;
      }

      nav.site-nav a::after {
        content: "";
        position: absolute;
        left: 0;
        bottom: -0.2rem;
        width: 0;
        height: 1px;
        background: #999;
        transition: width 0.2s ease;
      }

      nav.site-nav a:hover::after {
        width: 100%;
      }

      @media (max-width: 600px) {
        header.site-header {
          height: auto;
          padding: 1.5rem 1.2rem 1rem;
          margin-top: 2rem;
          flex-direction: column;
          align-items: center;
        }

        .site-title-link {
          position: static;
          transform: none;
          margin-bottom: 0.3rem;
        }

        .site-logo {
          height: 84px;
        }

        nav.site-nav {
          position: static;
          margin-top: 0.4rem;
        }

        nav.site-nav a {
          font-size: 1.2rem;
          margin-left: 0.6rem;
        }
      }

      main.page-main {
        max-width: 960px;
        margin: 0 auto;
        padding: 2rem 1.5rem 3rem;
        text-align: center;
      }

      #canvas-container {
        position: fixed;
        inset: 0;
        z-index: -1;
      }

      .site-footer {
        margin-top: 3rem;
        padding: 1.5rem 0 2rem;
        text-align: center;
        font-size: 0.8rem;
        color: #777;
      }
    </style>
  </head>

  <body data-show-canvas={showCanvas} data-enable-links={enableLinks}>
    {showCanvas && <div id="canvas-container"></div>}

    <header class="site-header">
      <a href="/" class="site-title-link" aria-label="KoLLOID">
        <img class="site-logo" src="/logo.png" alt="KoLLOID" />
      </a>

      <nav class="site-nav">
        <a href="/about">About</a>
        <a href="/statement">Statement</a>
        {/* <a href="/contributors">Contributors</a> */}
      </nav>
    </header>

    <main class="page-main">
      <slot />
    </main>

    <footer class="site-footer">© KoLLOID, 2025–</footer>

    {/* ★ script は常に出す（showCanvas=false のページでも destroy できるように） */}
    <script type="module" is:inline>
      import { createKolloidSketch } from "/js/kolloid-particles.js?v=20251223-1";

      function getFlags() {
        const root = document.body;
        const showCanvas = root.dataset.showCanvas === "true";
        const enableLinks = root.dataset.enableLinks === "true";
        return { showCanvas, enableLinks };
      }

      function destroySketch() {
        if (window.__kolloidP5__) {
          try {
            window.__kolloidP5__.remove();
          } catch (e) {
            console.warn("p5 remove failed:", e);
          }
          window.__kolloidP5__ = null;
        }

        const container = document.getElementById("canvas-container");
        if (container) container.innerHTML = "";
      }

      function initSketch() {
        const { showCanvas, enableLinks } = getFlags();

        // まず掃除
        destroySketch();

        // キャンバスを出さないページはここで終わり
        if (!showCanvas) return;

        // p5 がロードされていない場合は何もしない（安全策）
        if (!window.p5) {
          console.warn("p5 is not loaded (showCanvas=true).");
          return;
        }

        window.__kolloidP5__ = new p5(createKolloidSketch({ enableLinks }));
      }

      // フルロード
      window.addEventListener("DOMContentLoaded", initSketch);

      // Astro の遷移
      document.addEventListener("astro:before-swap", destroySketch);
      document.addEventListener("astro:after-swap", initSketch);
      document.addEventListener("astro:page-load", initSketch);
    </script>
  </body>
</html>