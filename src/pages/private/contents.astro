---
import BaseLayout from "../../layouts/BaseLayout.astro";
import contributors from "../../data/contributors.json";
import fs from "node:fs/promises";
import path from "node:path";

type Particle = {
  id?: string;
  contributor: string;
  title: string;
  link: string;
  genre?: string;
  updatedAt?: string;
};

type Contributor = {
  displayName: string;
  genres?: string[];
  links?: Record<string, string>;
};

type ContributorsMap = Record<string, Contributor>;

const pageTitle = "Contents | KoLLOID";

const contributorsMap = contributors as ContributorsMap;

// ★ここが肝：プロジェクトルートから public/data/particles.json を読む
const particlesPath = path.join(process.cwd(), "public", "data", "particles.json");

let particles: Particle[] = [];
try {
  const raw = await fs.readFile(particlesPath, "utf-8");
  const parsed = JSON.parse(raw);
  particles = Array.isArray(parsed) ? (parsed as Particle[]) : [];
} catch (e) {
  console.warn("[contents] failed to read particles.json:", particlesPath, e);
  particles = [];
}
---

<BaseLayout pageTitle={pageTitle} enableLinks={false}>
  <article style="text-align:left; max-width:760px; margin:0 auto;">
    <h2>Contents</h2>
    <p style="font-size:0.85rem; color:#777;">
    contributors: {Object.keys(contributorsMap).length} /
    particles: {particles.length}
    </p>

    <p style="font-size:0.85rem; color:#777; margin-bottom:1.5rem;">
      ※ このページは KoLLOID 運営用のコンテンツ一覧です。
    </p>

    {Object.entries(contributorsMap).map(([key, contributor]) => {
      const items = particles
        .filter((p) => p.contributor === key)
        .sort((a, b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));

      if (items.length === 0) return null;

      return (
        <section style="margin-top:2.5rem;">
          <h3 style="margin-bottom:0.3rem;">
            {contributor.displayName}
          </h3>

          {contributor.genres?.length ? (
            <p style="font-size:0.85rem; color:#777; margin-bottom:0.6rem;">
              ジャンル：{contributor.genres.join(" / ")}
            </p>
          ) : null}

          <ul style="padding-left:1.2rem; margin:0;">
            {items.map((item) => (
              <li style="margin-bottom:0.5rem;">
                <a
                  href={item.link}
                  target="_blank"
                  rel="noopener noreferrer"
                  style="text-decoration:underline;"
                >
                  {item.title}
                </a>
                <span style="color:#777; font-size:0.85rem;">
                  {" "}（{item.genre || "—"}
                  {item.updatedAt ? ` / ${item.updatedAt}` : ""}
                  ）
                </span>
              </li>
            ))}
          </ul>
        </section>
      );
    })}
  </article>
</BaseLayout>
